version: "3.6"

#
# Redis 1master-1slave (M-S)
#

#
# Example port
#
# master 21000
#
# slave 22000
#

x-deploy:
  &default-deploy
  restart_policy:
    condition: any
    delay: 5s
    max_attempts: 5
    window: 123s
  update_config:
    parallelism: 2
    delay: 10s
    order: stop-first

x-common:
  &default-common
  image: redis:4.0.8-alpine
  restart: always
  environment:
    - REDIS_HOST=${CLUSTERKIT_REDIS_M_S_HOST:-192.168.199.100}
  networks:
    - redis_master_slave
  # logging:
  #   driver: journald
  secrets:
    - source: redis_conf
      target: /redis.conf

x-labels:
  &default-labels
  labels:
    - "${LNMP_DOMAIN:-com.khs1994.lnmp}=true"
    - "${LNMP_DOMAIN:-com.khs1994.lnmp}.clusterkit=true"
    - "${LNMP_DOMAIN:-com.khs1994.lnmp}.app.env=clusterkit_redis_master_slave"

services:

  redis_m_s_master:
    << : *default-common
    << : *default-labels
    ports:
       - "21000:21000"
    volumes:
      - redis_master-data:/data:rw
    command: [
      "redis-server",
      "/redis.conf",
      "--daemonize no",
      "--port 21000",
      # "--logfile /var/log/redis/redis.log",
      "--bind 0.0.0.0",
      "--slave-announce-ip ${CLUSTERKIT_REDIS_M_S_HOST:-192.168.199.100}",
      "--slave-announce-port 21000"
      ]
    deploy:
      << : *default-deploy
      << : *default-labels
      # replicas: 2
      placement:
        constraints: [node.role == manager]

  redis_m_s_slave-1:
    << : *default-common
    << : *default-labels
    ports:
      - "22000:22000"
    volumes:
      - redis_slave-1-data:/data:rw
    command: [
      "redis-server",
      "/redis.conf",
      "--daemonize no",
      "--bind 0.0.0.0",
      "--port 22000",
      # "--logfile /var/log/redis/redis.log",
      "--slaveof redis_master 21000",
      "--slave-announce-ip ${CLUSTERKIT_REDIS_M_S_HOST:-192.168.199.100}",
      "--slave-announce-port 22000"
      ]
    depends_on:
      - redis_m_s_master
    deploy:
      << : *default-deploy
      << : *default-labels
      replicas: 1
      # placement:
      #   constraints: [node.role == manager]

volumes:
  redis_master-data:
    << : *default-labels

  redis_slave-1-data:
    << : *default-labels

networks:
  redis_master_slave:
    << : *default-labels

secrets:
  redis_conf:
    << : *default-labels
    file: ./config/redis/redis.conf
