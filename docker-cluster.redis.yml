version: '3.5'

#
# Redis cluster by Ruby
#
# 6 node 3 master 3 slave
#
# @link https://www.cnblogs.com/lianggp/articles/8136222.html
#
# @link https://redis.io/topics/cluster-tutorial
#

#
# You Must Find `192.168.199.100` replace your `HOST_IP`
#

#
# Example port
#
# 7001 7002 7003 17001 17002 17003
# 8001 8002 8003 18001 18002 18003
#

# There list  Docker commandï¼ŒIn production please use CLI (./lnmp-docker.sh)
#
# Start
#
# $ docker-compose -f docker-compose.yml -f docker-compose.override.yml -f docker-cluster.redis.yml up [-d]
#
# Exec
#
## Bash
#
# $ docker exec -it $(docker container ls --format "{{.ID}}" --filter label=com.khs1994.lnmp.clusterkit.redis=master1) sh
#
## Fish
#
# $ docker exec -it (docker container ls --format "{{.ID}}" --filter label=com.khs1994.lnmp.clusterkit.redis=master1) sh
#
# Remove ALL [include Volumes]
#
# $ docker-compose -f docker-compose.yml -f docker-compose.override.yml -f docker-cluster.redis.yml down [-v]
#
#
# Swarm mode (Start LNMP With Redis Cluster)
#
#
# $ docker stack deploy -c docker-production.yml -c docker-cluster.redis.yml lnmp
#
# $ docker stack rm lnmp
#
#
# PHP connect BY CLUSTER HOST_IP
#
#

x-common:
  &default-common
  image: redis:4.0.8-alpine
  restart: always
  env_file:
    - ./cluster/.env
  networks:
    cluster_redis:
      # ipv4_address: 172.16.0.105
  secrets:
    - source: cluster_redis_conf
      target: /redis.conf

x-deploy:
  &default-deploy
  restart_policy:
    condition: any
    delay: 5s
    max_attempts: 5
    window: 123s
  update_config:
    parallelism: 2
    delay: 10s
    order: stop-first

x-labels:
  &default-labels
  labels:
    - "com.khs1994.lnmp=true"
    - "com.khs1994.lnmp.clusterkit=true"
    - "com.khs1994.lnmp.app.env=clusterkit_redis"

services:

  redis_ruby:
    << : *default-common
    << : *default-labels
    # build:
    #   context: ./cluster/redis
    #   args:
    #     REDIS_URL: gitee.com/mirrors/redis/raw
    image: khs1994/redis:clusterkit-4.0.8
    volumes:
      - cluster_redis_master-1-data:/data
    deploy:
      << : *default-deploy
      placement:
        constraints: [node.role == manager]
      # resources:
      #   limits:
      #     cpus: '0.50'
      #     memory: 50M
      #   reservations:
      #     cpus: '0.25'
      #     memory: 20M

  redis_master-1:
    << : *default-common
    command: [
      "redis-server",
      "/redis.conf",
      "--daemonize no",
      "--bind 0.0.0.0",
      "--port 7001",
      "--cluster-announce-ip 192.168.199.100",
      "--cluster-announce-port 7001",
      "--cluster-announce-bus-port 17001"
      ]
    volumes:
      - cluster_redis_master-1-data:/data
    deploy:
      << : *default-deploy
      << : *default-labels
      placement:
        constraints: [node.role == manager]
      # resources:
      #   limits:
      #     cpus: '0.50'
      #     memory: 50M
      #   reservations:
      #     cpus: '0.25'
      #     memory: 20M
    expose:
      - "7001"
      - "17001"
    ports:
      - "7001:7001"
      - "17001:17001"

  redis_master-2:
    << : *default-common
    << : *default-labels
    depends_on:
      - redis_master-1
    expose:
      - "7002"
      - "17002"
    ports:
      - "7002:7002"
      - "17002:17002"
    command: [
      "redis-server",
      "/redis.conf",
      "--daemonize no",
      "--bind 0.0.0.0",
      "--port 7002",
      "--cluster-announce-ip 192.168.199.100",
      "--cluster-announce-port 7002",
      "--cluster-announce-bus-port 17002"
      ]
    volumes:
      - cluster_redis_master-2-data:/data
    deploy:
      << : *default-deploy
      << : *default-labels
      placement:
        constraints: [node.role == manager]
      # resources:
      #   limits:
      #     cpus: '0.50'
      #     memory: 50M
      #   reservations:
      #     cpus: '0.25'
      #     memory: 20M

  redis_master-3:
    << : *default-common
    << : *default-labels
    depends_on:
      - redis_master-1
    expose:
      - "7003"
      - "17003"
    ports:
      - "7003:7003"
      - "17003:17003"
    command: [
      "redis-server",
      "/redis.conf",
      "--daemonize no",
      "--bind 0.0.0.0",
      "--port 7003",
      "--cluster-announce-ip 192.168.199.100",
      "--cluster-announce-port 7003",
      "--cluster-announce-bus-port 17003"
      ]
    volumes:
      - cluster_redis_master-3-data:/data
    deploy:
      << : *default-deploy
      << : *default-labels
      placement:
        constraints: [node.role == manager]
      # resources:
      #   limits:
      #     cpus: '0.50'
      #     memory: 50M
      #   reservations:
      #     cpus: '0.25'
      #     memory: 20M

  redis_slave-1:
    << : *default-common
    << : *default-labels
    depends_on:
      - redis_master-1
    expose:
      - "8001"
      - "18001"
    ports:
      - "8001:8001"
      - "18001:18001"
    command: [
      "redis-server",
      "/redis.conf",
      "--daemonize no",
      "--bind 0.0.0.0",
      "--port 8001",
      "--cluster-announce-ip 192.168.199.100",
      "--cluster-announce-port 8001",
      "--cluster-announce-bus-port 18001"
      ]
    volumes:
      - cluster_redis_slave-1-data:/data
    deploy:
      << : *default-deploy
      << : *default-labels
      replicas: 1
      # resources:
      #   limits:
      #     cpus: '0.50'
      #     memory: 50M
      #   reservations:
      #     cpus: '0.25'
      #     memory: 20M

  redis_slave-2:
    << : *default-common
    << : *default-labels
    depends_on:
      - redis_master-1
    expose:
      - "8002"
      - "18002"
    ports:
      - "8002:8002"
      - "18002:18002"
    command: [
      "redis-server",
      "/redis.conf",
      "--daemonize no",
      "--bind 0.0.0.0",
      "--port 8002",
      "--cluster-announce-ip 192.168.199.100",
      "--cluster-announce-port 8002",
      "--cluster-announce-bus-port 18002"
      ]
    volumes:
      - cluster_redis_slave-2-data:/data
    deploy:
      << : *default-deploy
      << : *default-labels
      replicas: 1
      # resources:
      #   limits:
      #     cpus: '0.50'
      #     memory: 50M
      #   reservations:
      #     cpus: '0.25'
      #     memory: 20M

  redis_slave-3:
    << : *default-common
    << : *default-labels
    depends_on:
      - redis_master-1
    expose:
      - "8003"
      - "18003"
    ports:
      - "8003:8003"
      - "18003:18003"
    command: [
      "redis-server",
      "/redis.conf",
      "--daemonize no",
      "--bind 0.0.0.0",
      "--port 8003",
      "--cluster-announce-ip 192.168.199.100",
      "--cluster-announce-port 8003",
      "--cluster-announce-bus-port 18003"
      ]
    volumes:
      - cluster_redis_slave-3-data:/data
    deploy:
      << : *default-deploy
      << : *default-labels
      replicas: 1
      # resources:
      #   limits:
      #     cpus: '0.50'
      #     memory: 50M
      #   reservations:
      #     cpus: '0.25'
      #     memory: 20M

networks:
  cluster_redis:
    << : *default-labels
    ipam:
      driver: default
      config:
        - subnet: 172.16.0.0/24

secrets:
  cluster_redis_conf:
    << : *default-labels
    file: ./cluster/redis/redis.conf

volumes:
  cluster_redis_master-1-data:
    << : *default-labels

  cluster_redis_master-2-data:
    << : *default-labels

  cluster_redis_master-3-data:
    << : *default-labels

  cluster_redis_slave-1-data:
    << : *default-labels

  cluster_redis_slave-2-data:
    << : *default-labels

  cluster_redis_slave-3-data:
    << : *default-labels
