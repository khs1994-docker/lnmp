#!/bin/bash

#   $ curl -fsSL lnmp.khs1994.com -o lnmp.sh ; sh lnmp.sh
# Use in Production
#   $ curl -fsSL lnmp.khs1994.com -o lnmp.sh ; sh lnmp.sh production
#
# CN mirror
#   $ curl -fsSL lnmp.khs1994.com -o lnmp.sh ; sh lnmp.sh --mirror aliyun | coding | tgit | gitee
#

LNMP_GIT_SSH_URL=git@github.com:khs1994-docker/lnmp.git

LNMP_GIT_HTTPS_URL=https://github.com/khs1994-docker/lnmp.git

LNMP_PATH=lnmp

BRANCH=dev

echo "Welcome use khs1994-docker/lnmp"

clone_ssh(){
  echo "Your Branch is ${BRANCH}"
  echo "Clone by SSH way"
  git clone --recursive -b ${BRANCH} ${LNMP_GIT_SSH_URL} $1
}

clone_https(){
  echo "Your Branch is ${BRANCH}"
  echo "Clone by SSH way is failure, try HTTPS way"
  git clone --recursive -b ${BRANCH} ${LNMP_GIT_HTTPS_URL} $1
}

wget_git(){
  echo "Download by wget way"
  wget "https://github.com/khs1994-docker/lnmp/archive/${BRANCH}.zip" -O $1.zip
  unzip -o $1.zip -d $1 >/dev/null 2>&1
  cd $1
  cp -a lnmp-dev/. .
  rm -rf lnmp-dev ../$1.zip
  success
}

exist_path() {
  if [ -d ${LNMP_PATH} -o -f ${LNMP_PATH} ];then
    echo "${LNMP_PATH} exists"
    echo "==============================="
    read -p "Please input path: " LNMP_PATH
    exist_path
  fi
}

success(){
  echo "=================================="
  echo "==========  SUCCESS =============="
  echo "=================================="
  echo "Success please exec "
  echo "$ cd ${LNMP_PATH}"
    if [ $BRANCH = "master" ];then
      echo "$ ./lnmp-docker.sh production"
    else
      echo "$ ./lnmp-docker.sh development"
    fi
  exit 0
}

error(){
  echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"
  echo "!!!!!!!!!!!  ERROR  !!!!!!!!!!!!!!"
  echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"
  exit 1
}

function clone(){
    clone_ssh $LNMP_PATH
    if [ $? = "0" ];then
      success
    else
      clone_https $LNMP_PATH
      if [ $? = "0" ];then
        success
      else
        error
      fi
    fi
}

exist_path

case $1 in
  production )
    BRANCH=master
    ;;
  wget )
    wget_git $LNMP_PATH
    ;;
  --mirror )
    if [ "$3" = production ];then BRANCH=master; fi
    case $2 in
      aliyun )
      LNMP_GIT_SSH_URL=git@code.aliyun.com:khs1994-docker/lnmp.git
      LNMP_GIT_HTTPS_URL=https://code.aliyun.com/khs1994-docker/lnmp.git
      ;;
      coding )
      LNMP_GIT_SSH_URL=git@coding.net:khs1994/lnmp.git
      LNMP_GIT_HTTPS_URL=https://coding.net/khs1994/lnmp.git
      ;;
      tgit )
      LNMP_GIT_SSH_URL=git@git.qcloud.com:khs1994-docker/lnmp.git
      LNMP_GIT_HTTPS_URL=https://git.qcloud.com/khs1994-docker/lnmp.git
      ;;
      gitee )
      LNMP_GIT_SSH_URL=git@gitee.com:khs1994/lnmp.git
      LNMP_GIT_HTTPS_URL=https://gitee.com/khs1994/lnmp.git
      ;;
    esac
  --help )
  echo "production         : Clone master branch"
  echo "--mirror aliyun    : Clone from cn mirror"
  echo "wget               : Download by wget"
  ;;
  * )
  echo > /dev/null 2>&1
    ;;
esac

command -v git >/dev/null 2>&1

if [ $? -eq 0 ];then
  clone
else
  wget_git
fi

# WebSite https://github.com/khs1994-docker/lnmp
# License Apache License Version 2.0
