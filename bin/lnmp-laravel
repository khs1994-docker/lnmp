#!/bin/bash

set -e

if [ "$1" = 'new' ] && [ -z "$2" ];then
  exit 1
fi

DIR="$( cd "$( dirname "$0"  )" && pwd  )"

source $DIR/.arch

docker run -it --rm \
  --mount type=bind,src=$PWD,target=/app \
  --mount src=lnmp_composer_cache-data,target=/tmp/cache \
  ${DOCKER_IMAGE}:${TAG} \
  laravel "$@"

if [ "$1" = 'new' ];then
  LARAVEL_PATH="$2"
  echo -e "\n\033[32mINFO\033[0m  change folder own and group ..."

  if [ ${OS} = 'Linux' ] || [ ${OS} = 'Darwin' ];then
    sudo chmod -R 765 ${LARAVEL_PATH}
    sudo chown -R `id -u`:`id -g` ${LARAVEL_PATH}
    chmod -R 777 ${LARAVEL_PATH}/storage
  fi

  echo -e "\n\033[32mINFO\033[0m  create new env file ..."

  mv ${LARAVEL_PATH}/.env ${LARAVEL_PATH}/.env.backup

  cp $DIR/../app/.env* ${LARAVEL_PATH}

  echo -e "\n\033[32mINFO\033[0m  change Redis config ..."

  if [ $OS = 'Darwin' ];then
    sed -i '' 's#predis#phpredis#g' ${LARAVEL_PATH}/config/database.php
  else
    sed -i 's#predis#phpredis#g' ${LARAVEL_PATH}/config/database.php
  fi

  echo -e "\n\033[32mINFO\033[0m  install laravel-ide-helper ..."

  $DIR/lnmp-composer require --dev barryvdh/laravel-ide-helper

  echo -e "Must EDIT ./app/Providers/AppServiceProvider.php add this content

  public function register()
  {
      if ($this->app->environment() !== 'production') {
          $this->app->register(\Barryvdh\LaravelIdeHelper\IdeHelperServiceProvider::class);
      }
      // ...
  }

then exec

$ lnmp-php artisan ide-helper:generate
$ lnmp-php artisan ide-helper:meta
$ lnmp-php artisan optimize
"

  echo -e ".phpstorm.meta.php
  _ide_helper.php" >> app/${LARAVEL_PATH}/.gitignore

fi
