#!/usr/bin/env bash

#
# https://github.com/yarnpkg/yarn
#

set -e

if [ "$debug" = 'true' ];then set -x; fi

ScriptRoot="$( cd "$( dirname "$0"  )" && pwd  )"

docker run -it --rm \
  --mount type=volume,src=lnmp_yarn_cache-data,target=/tmp/node/.yarn \
  --mount type=volume,src=lnmp_yarn_global-data,target=/tmp/node/yarn \
  bash \
  bash -c \
  "set -x;chown -R ${LNMP_USER} /tmp/node/.yarn; \
   chown -R ${LNMP_USER} /tmp/node/yarn; \
  "

docker run -it --rm \
    --mount type=bind,src=$PWD,target=/app,consistency=delegated \
    --mount type=volume,src=lnmp_yarn_cache-data,target=/tmp/node/.yarn \
    --mount type=volume,src=lnmp_yarn_global-data,target=/tmp/node/yarn \
    --mount type=bind,src=${ScriptRoot}/../config/yarn/.yarnrc,target=/root/.yarnrc \
    --env-file ${ScriptRoot}/../config/yarn/.env \
    --workdir /app \
    --entrypoint yarn \
    --user ${LNMP_USER:-root:root} \
    ${LNMP_NODE_IMAGE:-node:alpine} \
    --registry https://registry.npm.taobao.org \
    --cache-folder /tmp/node/.yarn \
    --global-folder /tmp/node/yarn \
    "$@"
