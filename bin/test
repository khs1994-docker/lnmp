#!/bin/bash

if [ -f "khs1994-robot.enc" ];then echo -e "\n\033[32mINFO\033[0m  不允许在 bin 目录中执行"; exit 1; fi

# 删除原项目

print_info(){
  echo -e "\033[32mINFO\033[0m  $1\n"
}

delete(){
  docker-compose down -v
  print_info "删除原有项目成功"
}

docker_run(){
  docker ps -a

  sleep 5

  curl 127.0.0.1

  docker ps -a \
    && docker-compose down \
    && print_info $1
}

# 测试开发环境

development(){
  print_info "开发测试开始"

  ./lnmp-docker.sh development

  docker_run "开发境测试完毕"
}

# 测试生产环境

production(){
  print_info "生产环境测试开始"

  ./lnmp-docker.sh production

  docker_run "生产环境测试完毕"
}

k8s(){
  echo
}

swarm(){
  docker node ls > /dev/null 2>&1
  if [ $? != 0 ];then docker swarm init; fi
  docker stack rm lnmp
  docker stack deploy -c docker-stack.yml lnmp
  until curl 127.0.0.1; do
    echo "Wait nginx service start"
  done
  sleep 120
  docker ps -a
  docker stack ls
  docker stack ps lnmp
  docker stack services lnmp
  docker stack rm lnmp
}

# 测试 composer

composer(){

bin/composer demo --version

print_info "测试 composer 完毕"
}

if [ ! -z "$1" ];then $1; else development; production; swarm; k8s; fi
