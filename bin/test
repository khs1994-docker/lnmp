#!/bin/bash

set -e

if [ -f "khs1994-robot.enc" ];then
  echo -e "\n\033[32mINFO\033[0m  不允许在 bin 目录中执行"
  exit 1
fi

echo $0

# 生产环境自动测试脚本，开发环境由本人真机手动测试
# 删除原项目

docker-compose down -v

echo -e "\033[32mINFO\033[0m  删除原有项目成功\n"

# 测试生产环境

echo -e "\033[32mINFO\033[0m  生产环境测试开始\n"

docker_run(){
  docker ps -a

  sleep 5

  curl 127.0.0.1

  docker ps -a \
    && docker-compose down \
    && echo -e "\033[32mINFO\033[0m  $1\n"
}

./lnmp-docker.sh production

docker_run "生产环境测试完毕"

./lnmp-docker.sh test-image

docker_run "测试 test 镜像"

# 测试 composer

bin/composer demo --version

echo -e "\033[32mINFO\033[0m  测试 composer 完毕\n"
