#!/bin/bash
. .env
echo -e "$0\n"
LARAVEL_PATH=$1
ARCH=`uname -m`

if [ $ARCH = "armv7l" ];then
  DOCKER_IMAGE=khs1994/arm32v7-php-fpm
  TAG=${KHS1994_LNMP_PHP_VERSION}
elif [ $ARCH = "aarch64" ]; then
  DOCKER_IMAGE=khs1994/arm64v8-php-fpm
  TAG=${KHS1994_LNMP_PHP_VERSION}
elif [ $ARCH = "x86_64" ];then
  DOCKER_IMAGE=khs1994/php-fpm
  TAG=${KHS1994_LNMP_PHP_VERSION}-alpine
else
  DOCKER_IMAGE="false"
fi

# if build image
# DOCKER_IMAGE=lnmp-php
if [ ${DOCKER_IMAGE} = "false" ];then
    echo -e "\n\033[32mINFO\033[0m  ${ARCH} 暂不支持"
else

echo -e  "\n\033[32mINFO\033[0m  在 ${DOCKER_IMAGE}:${TAG} 内 /app/ 执行 laravel new ${LARAVEL_PATH}" && echo -e  "\n\033[32mINFO\033[0m  以下为输出内容\n\n"

docker run --rm -it \
       -v $PWD/tmp/cache:/tmp/cache \
       -v $PWD/app:/app \
       ${DOCKER_IMAGE}:${TAG} \
       laravel new $LARAVEL_PATH

#sudo chmod -R 777 app/$1

sudo chown -R `id -u`:`id -g` app/$1

# 使用 .env.development 或 .env.production 不使用 .env 文件

mv app/$1/.env app/$1/.env.backup

cp app/.env* app/$1

chmod -R 777 app/$1/storage
fi
