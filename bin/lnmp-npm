#!/usr/bin/env bash

#
# https://github.com/npm/npm
#

set -e

if [ "$debug" = 'true' ];then set -x; fi

ScriptRoot="$( cd "$( dirname "$0"  )" && pwd  )"

source $ScriptRoot/.arch

docker run -it --rm \
  --mount type=volume,src=lnmp_npm_cache-data,target=/tmp/node/.npm \
  --mount type=volume,src=lnmp_npm_global-data,target=/tmp/node/npm \
  bash \
  bash -c \
  "set -x;chown -R ${LNMP_USER} /tmp/node/.npm; \
   chown -R ${LNMP_USER} /tmp/node/npm; \
  "

docker run -it --rm \
    --mount type=bind,src=$PWD,target=/app,consistency=delegated \
    --mount type=bind,src=${ScriptRoot}/../config/npm/.npmrc,target=/usr/local/etc/npmrc \
    --mount type=volume,src=lnmp_npm_cache-data,target=/tmp/node/.npm \
    --mount type=volume,src=lnmp_npm_global-data,target=/tmp/node/npm \
    --env-file ${ScriptRoot}/../config/npm/.env \
    --workdir /app \
    --entrypoint npm \
    --user ${LNMP_USER:-root:root} \
    ${LNMP_NODE_IMAGE:-node:alpine} \
    "$@"
